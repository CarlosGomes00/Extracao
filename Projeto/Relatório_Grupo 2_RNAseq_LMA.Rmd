---
title: "Relatório sobre dados de RNA-seq de pacientes com Leucemia Mielóide Aguda" 
output: 
  html_document:
    theme: flatly
date: '`r Sys.Date()`'
author: "Carlos Gomes (PG51681), Laís Carvalho (PG52536) e Rita Nóbrega (PG46733)" 
---

<img src="EEUM_logo.jpg" alt="Logo da Empresa" style="float:right; margin: 10px 10px 0 0; width: 110px; height: auto;"/>

## Instalação dos packages necessários

```{r Instalação dos packages necessários à realização do trabalho}
install.packages("tidyverse")
install.packages("arules")
install.packages("data.table")
install.packages("summarytools")
install.packages("ggpubr")
if (!requireNamespace("BiocManager", quietly = TRUE))
    install.packages("BiocManager")
BiocManager::install("limma")
if (!requireNamespace("BiocManager", quietly = TRUE))
    install.packages("BiocManager")
BiocManager::install("Glimma")
if (!requireNamespace("BiocManager", quietly = TRUE))
    install.packages("BiocManager")
BiocManager::install("edgeR")
if (!requireNamespace("BiocManager", quietly = TRUE))
    install.packages("BiocManager")
BiocManager::install("org.Hs.eg.db")
if (!requireNamespace("BiocManager", quietly = TRUE))
    install.packages("BiocManager")
BiocManager::install("GO.db")
install.packages("car")
install.packages("caret")
install.packages("RColorBrewer")
install.packages("gplots")
install.packages("FactoMineR")
install.packages("factoextra")
```

## Importação dos packages

```{r Importação dos packages necessários}
library(readr)
library(readxl)
library(data.table)
library(tibble)
#library(tidyverse)
library(arules)
library(dplyr)
#library(summarytools)
#library(ggpubr)
library(limma)
library(Glimma)
library(edgeR)
library(org.Hs.eg.db)
library(GO.db)
#library(car)
#library(caret)
library(RColorBrewer)
library(gplots)
#library(FactoMineR)
#library(factoextra)
```

## Introdução

**LMA**

**Explicação, origem e relevância dos dados**

O conjunto de dados selecionados para este trabalho foram retirados de um estudo cohort com 672 amostras recolhidas através de biopsias a 562 pacientes com Leucemia Mielóide Aguda (LMA) (Tyner et al., 2018). Com o objetivo de correlacionar a sensibilidade e resistência de grupos de pacientes com LMA a tratamentos já existentes com a ocorrência de mutações, foram realizadas anotações clínicas detalhadas, estudos genómicos e transcriptómicos (com a sequenciação do exoma (622 amostras) e do RNA (451 amostras)), assim como testes *ex vivo* de sensibilidade a compostos. Os dados e estudo original podem ser consultados através do Genomic Data Commons (GDC) em <https://www.cbioportal.org/study/summary?id=aml_ohsu_2018>.

Este trabalho tem como objetivo analisar os dados de expressão de pacientes com AML, comparando os seus dados transcriptómicos com amostras controlo (saudáveis), com vista a obter informações sobre genes diferencialmente expressos e enriquecidos, clusters de genes e/ou de amostras e que genes parecem ter maior importância no transcriptoma associado a AML.

Começamos por carregar os dados relativos aos Z-score das contagens feitas após a análise das sequências de RNA obtidas e metadados relativos às amostras e aos pacientes.

## Carregamento dos dados e metadados

```{r Carregamento dos dados e metadados}
# Carregamento dos dados através do url: https://raw.githubusercontent.com/lais-carvalho/Trabalho-pratico/main/Dados/

# Primeiro associamos o url a uma variável
RNA_rpkm_zscore_url = "https://raw.githubusercontent.com/lais-carvalho/Trabalho-pratico/main/Dados/data_mrna_seq_rpkm_zscores_ref_all_samples.txt"
data_patient_url = "https://raw.githubusercontent.com/lais-carvalho/Trabalho-pratico/main/Dados/data_clinical_patient.txt"
data_sample_url = "https://raw.githubusercontent.com/lais-carvalho/Trabalho-pratico/main/Dados/data_clinical_sample.txt"

# Depois fazemos o download do ficheiro no url e guardamos uma cópia local 
download.file(RNA_rpkm_zscore_url, destfile="RNA_seq_rpkm_zscore.txt")
download.file(data_patient_url, destfile="data_patient.txt") 
download.file(data_sample_url, destfile ="data_sample.txt")

# Leitura do ficheiro 
rna_rpkm_zscore = read.table("RNA_seq_rpkm_zscore.txt", header = T, sep = '\t')
data_patient = read.table("data_patient.txt", header = T, sep = '\t')
data_sample = read_tsv("data_sample.txt", na = "")
```

```{r Visualização dos datasets carregados}
rna_rpkm_zscore
data_patient
data_sample

```



Uma primeira e rápida verificação dos datasets carregados permitem perceber dois aspetos importantes sobre os dados relativos aos Z-scores:
- a segunda coluna intitulada 'Entrez_gene_id' está vazia pois o nome dos genes já está na primeira coluna;
- os genes (as variáveis) estão representados nas linhas enquanto as amostras (as entidades) estão representadas nas colunas.
Estes dois aspetos do nosso dataset fazem com que seja necessário transpôr o dataset carregado para ter a estrutura desejada (variáveis representadas nas colunas e entidades representadas nas linhas) e, após verificação da presença de mais valores omissos, eliminar a  coluna 'Entrez_gene_id'.

Relativamente aos metadados, no dataset com informações sobre as amostras é possível ver que há vários missing values, que este dataset é um tibble e que as quatro primeiras linhas não são relativas a amostras, mas a informações sobre o que está em cada coluna. Assim, é necessário eliminar estas linhas e transformar este dataset em dataframe para facilitar a sua manipulação.    

Como esta rápida visualização dos datasets não é suficiente para termos a certeza que os dados estão preparados para análise, é necessário fazer uma verificação mais detalhada de determinadas características dos datasets tais como:
- Nome das variáveis para que sejam fáceis de usar e informativas (caso não o sejam, iremos alterar o nome da variável);
- Dimensões do dataset para nos certificarmos que a quantidade de dados (variáveis e amostras) é a esperada consoante a descrição dos datasets;
- Estrutura que inclui a classe dos dados e os valores de cada fator, por exemplo;
- Valores Omissos.

## Verificação dos ficheiros carregados
```{r Verificação dos dados, da sua estrutura, classe e valores omissos}
# Verificar a estrutura dos dados
class(rna_rpkm_zscore)
## É um dataframe, o que é o suposto

# Verificação da classe de cada coluna 
unlist(lapply(rna_rpkm_zscore,class))  
## todas têm a classe suposto (ou seja, o nome dos genes é visto como string e os z-cores sao numéricos)

# Dimensão do dataframe
dim(rna_rpkm_zscore)
# temos 22843 linhas e 453 colunas
# dado que os genes estão representados nas linhas e as amostras estão representadas nas colunas, isto significa que temos 22842 genes nesta análise e (dado que há um coluna vazia) temos 251 amostras tal como esperado
# Verificar se as colunas são as corretas
rownames(rna_rpkm_zscore) #como esperado o nome dos genes não está associado ao nome das linhas porque não o conseguimos fazer aquando da função read.table()
# há nomes duplicados por isso temos que encontrar os que estão duplicados e adicionar um '_duplicado' para sabermos que o são e conseguirmos associar o nome dos genes às linhas

which(duplicated(rna_rpkm_zscore[,1])) # há 6 genes que têm os nomes repetidos
rna_rpkm_zscore[which(duplicated(rna_rpkm_zscore[,1])),1]
which(rna_rpkm_zscore == 'BTBD8', arr.ind = T)
which(rna_rpkm_zscore == 'COMMD9', arr.ind = T)
#depois de verificação manual de dois exemplos destes nomes de genes duplicados, verificámos que de facto o nome é o mesmo porém os valores de Z-cores são diferentes
#isto faz com que tenhamos de os distinguir adicionando no final do duplicado '_duplicado'
rna_rpkm_zscore[which(duplicated(rna_rpkm_zscore[,1])),1] <- paste(rna_rpkm_zscore[which(duplicated(rna_rpkm_zscore[,1])),1], "_duplicado", sep = "")
which(duplicated(rna_rpkm_zscore[,1]))
rna_rpkm_zscore[13532, 1]
#os nomes duplicados foram tratados por isso já podemos associar o nome dos genes às linhas
rownames(rna_rpkm_zscore) = rna_rpkm_zscore[, 1]
rownames(rna_rpkm_zscore)

# Verificar se existem missing values
any(is.na(rna_rpkm_zscore))
# Suspeitamos que os valores da coluna 'Entrez_gene_id' são os únicos valores únicos por isso vamos eliminar esta coluna do dataframe
rna_rpkm_zscore$Entrez_Gene_Id <- NULL
# Verificar outra vez se ainda há missing values
sum(is.na(rna_rpkm_zscore)) # ainda há 8118 valores omissos no nosso dataset
# Os valores omissos (NA) não nos vão permitir realizar análises posteriores com estes dados logo temos que tratar estes NA de alguma forma
# Provavelmente a melhor opção é substituir os NA pela média de cada coluna dado que uma coluna é uma amostra e uma linha um gene 
#( acho que o que faz mais sentido é substituir pelo valor média da amostra e não do gene porque amostras diferentes podem comportar-se de maneira diferente consoante o gene)
for (i in 2:ncol(rna_rpkm_zscore)){
  m = mean(rna_rpkm_zscore[, i], na.rm = T)
  rna_rpkm_zscore[is.na(rna_rpkm_zscore[,i]), i] = m
}

sum(is.na(rna_rpkm_zscore))
# Já não existem NA no nosso dataset


############### Metadados #########################
# falta fazer esta verificação inicial; ver se são dataframe (aquele que não é, precisamos de transformar em dataframe)
#ver se o nº de linhas corrresponde ao nº de amostras descritas
#ver se o nome das variaveis e amostras esão associados às colunas e linhas, respetivamente
#eu acho que é preciso ver se há NAs porém não os devemos substituir ou eliminar porque maior parte deles são caracteristicas das amostras logo não faz sentido eliminarou substituir pela média
# quanto ao juntar os datasets estive a ver trabalhos de outros anos e eles criam subsets dos metadados que têm as amostras presentes nos dados
#provavelmente é isto que temos de fazer
```

## Preparação e pré-processamento dos dados

```{r Preparação e pré-processamento dos dados}

#preparação
#pré-processamento
#filtragem
```

## Sumarização dos dados

```{r Sumarização dos dados}
#estatistica descritiva
#gráficos
```

## Análise estatítica Univariada: expressão diferencial e enriquecimento

```{r Análise dos dados}
#análise de expressão diferencial
#analise de enriquecimento
```

## Referências

Tyner, J. W., Tognon, C. E., Bottomly, D., Wilmot, B., Kurtz, S. E., Savage, S. L., Long, N., Schultz, A. R., Traer, E., Abel, M., Agarwal, A., Blucher, A., Borate, U., Bryant, J., Burke, R., Carlos, A., Carpenter, R., Carroll, J., Chang, B. H., Coblentz, C., … Druker, B. J. (2018). Functional genomic landscape of acute myeloid leukaemia. Nature, 562(7728), 526–531. <https://doi.org/10.1038/s41586-018-0623-z>
